{% extends "base.html" %}

{% block title %}Inventario de Medicamentos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/dashboard"><i class="bi bi-house"></i> Dashboard</a>
                </li>
                <li class="breadcrumb-item active">Inventario de Medicamentos</li>
            </ol>
        </nav>
        <h2 class="mb-0">
            <i class="bi bi-capsule"></i> Inventario de Medicamentos
        </h2>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
  <div class="col-md-3 mb-3">
    <div class="card text-center border-info">
      <div class="card-body">
        <i class="bi bi-capsule fs-1 text-info"></i>
        <h5 class="card-title">Total Medicamentos</h5>
        <p class="card-text fs-4 fw-bold text-info">{{ summary.total }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-center border-danger">
      <div class="card-body">
        <i class="bi bi-exclamation-triangle fs-1 text-danger"></i>
        <h5 class="card-title">Alertas Críticas</h5>
        <p class="card-text fs-4 fw-bold text-danger">{{ summary.critical }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-center border-warning">
      <div class="card-body">
        <i class="bi bi-exclamation-circle fs-1 text-warning"></i>
        <h5 class="card-title">Stock Bajo</h5>
        <p class="card-text fs-4 fw-bold text-warning">{{ summary.low_stock }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-center border-secondary">
      <div class="card-body">
        <i class="bi bi-clock fs-1 text-muted"></i>
        <h5 class="card-title">Última Actualización</h5>
        <p class="card-text fs-6 text-muted">{{ summary.last_update }}</p>
      </div>
    </div>
  </div>
</div>

<!-- Filter Buttons -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="bi bi-funnel"></i> Filtros por Estado
        </h6>
    </div>
    <div class="card-body py-2">
        <div class="btn-group flex-wrap" role="group">
            <a href="{{ url_for('pages.inventory') }}" 
               class="btn btn-outline-secondary btn-sm {% if not current_status %}active{% endif %}">
                <i class="bi bi-grid"></i> Todos
            </a>
            <a href="{{ url_for('pages.inventory', status='EXPIRED') }}" 
               class="btn btn-outline-danger btn-sm {% if current_status == 'EXPIRED' %}active{% endif %}">
                <i class="bi bi-x-circle"></i> Vencidos
            </a>
            <a href="{{ url_for('pages.inventory', status='EXPIRES_SOON') }}" 
               class="btn btn-outline-warning btn-sm {% if current_status == 'EXPIRES_SOON' %}active{% endif %}">
                <i class="bi bi-clock"></i> Por Vencer
            </a>
            <a href="{{ url_for('pages.inventory', status='EXPIRES_30') }}" 
               class="btn btn-outline-secondary btn-sm {% if current_status == 'EXPIRES_30' %}active{% endif %}">
                <i class="bi bi-calendar"></i> Vencen en 30 días
            </a>
            <a href="{{ url_for('pages.inventory', status='LOW_STOCK') }}" 
               class="btn btn-outline-warning btn-sm {% if current_status == 'LOW_STOCK' %}active{% endif %}">
                <i class="bi bi-exclamation-triangle"></i> Stock Bajo
            </a>
            <a href="{{ url_for('pages.inventory', status='OUT_OF_STOCK') }}" 
               class="btn btn-outline-dark btn-sm {% if current_status == 'OUT_OF_STOCK' %}active{% endif %}">
                <i class="bi bi-box"></i> Sin Stock
            </a>
            <a href="{{ url_for('pages.inventory', status='OK') }}" 
               class="btn btn-outline-success btn-sm {% if current_status == 'OK' %}active{% endif %}">
                <i class="bi bi-check-circle"></i> OK
            </a>
        </div>
    </div>
</div>

<!-- Medicines Tables Grouped -->
{% set total_medicines = 0 %}
{% for group_name, meds in grouped_data.items() %}
    {% set total_medicines = total_medicines + meds|length %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-table"></i> 
                {{ group_name }}
                {% if current_status %}
                <span class="badge bg-primary ms-2">Filtro: {{ current_status }}</span>
                {% endif %}
            </h5>
            <small class="text-muted">{{ meds|length }} medicamentos mostrados</small>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Botiquín</th>
                            <th>Compartimento</th>
                            <th>Medicamento</th>
                            <th>Marca</th>
                            <th>Concentración</th>
                            <th>Fecha Vencimiento</th>
                            <th>Inventario</th>
                            <th>Peso</th>
                            <th>Último Escaneo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for med in meds %}
                        <tr>
                            <!-- Botiquin Info -->
                            <td>
                                <div>
                                    <strong>{{ med["botiquin_name"] }}</strong>
                                    {% if show_company and med.get("company_name") %}
                                    <br><small class="text-muted">{{ med["company_name"] }}</small>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <!-- Compartment -->
                            <td class="text-center">
                                {% if med["compartment_number"] %}
                                <span class="badge bg-secondary"># {{ med["compartment_number"] }}</span>
                                {% else %}
                                <span class="text-muted">No asignado</span>
                                {% endif %}
                            </td>
                            
                            <!-- Medicine Info -->
                            <td>
                                <div>
                                    <strong>{{ med["trade_name"] }}</strong>
                                    <br><small class="text-muted">{{ med["generic_name"] }}</small>
                                </div>
                            </td>
                            
                            <td>{{ med["brand"] or "N/A" }}</td>
                            <td>{{ med["strength"] or "N/A" }}</td>
                            
                            <!-- Expiry Date -->
                            <td>
                                {% if med["expiry_date"] %}
                                    {{ med["expiry_date"] }}
                                    {% if med["days_to_expiry"] is not none %}
                                        {% if med["days_to_expiry"] < 0 %}
                                        <br><small class="text-danger">Vencido hace {{ -med["days_to_expiry"] }} días</small>
                                        {% elif med["days_to_expiry"] <= 30 %}
                                        <br><small class="text-warning">{{ med["days_to_expiry"] }} días restantes</small>
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                <span class="text-muted">No especificada</span>
                                {% endif %}
                            </td>
                            
                            <!-- Quantity Progress Bar -->
                            <td style="min-width: 120px;">
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                        {% set percent = (med["quantity"] / med["reorder_level"] * 100) if med["reorder_level"] > 0 else 0 %}
                                        <div class="progress-bar 
                                                    {% if percent <= 0 %}bg-dark
                                                    {% elif percent < 50 %}bg-warning text-dark
                                                    {% elif percent < 100 %}bg-info
                                                    {% else %}bg-success{% endif %}"
                                             role="progressbar"
                                             style="width: {{ [percent, 100]|min }}%;"
                                             aria-valuenow="{{ percent|round(0) }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ med["quantity"] }}
                                        </div>
                                    </div>
                                    <small class="text-muted">/ {{ med["reorder_level"] }}</small>
                                </div>
                            </td>
                            
                            <!-- Weight Info -->
                            <td>
                                {% if med["current_weight"] %}
                                <div>
                                    <strong>{{ med["current_weight"] }}g</strong>
                                    {% if med["unit_weight"] %}
                                    <br><small class="text-muted">{{ med["unit_weight"] }}g/unidad</small>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            
                            <!-- Last Scan -->
                            <td>
                                {% if med["last_scan_at"] %}
                                <small>{{ med["last_scan_at"][:16] }}</small>
                                {% else %}
                                <small class="text-muted">Nunca</small>
                                {% endif %}
                            </td>
                            
                            <!-- Status Badge -->
                            <td>
                                {% set status_map = {
                                    "OUT_OF_STOCK": {"class": "dark", "icon": "box", "text": "Sin Stock"},
                                    "EXPIRED": {"class": "danger", "icon": "x-circle", "text": "Vencido"},
                                    "EXPIRES_SOON": {"class": "warning", "icon": "clock", "text": "Por Vencer"},
                                    "EXPIRES_30": {"class": "secondary", "icon": "calendar", "text": "Vence ≤30 días"},
                                    "LOW_STOCK": {"class": "warning", "icon": "exclamation-triangle", "text": "Stock Bajo"},
                                    "OK": {"class": "success", "icon": "check-circle", "text": "OK"}
                                } %}
                                {% set status_info = status_map.get(med["status"], {"class": "secondary", "icon": "question", "text": med["status"]}) %}
                                <span class="badge bg-{{ status_info.class }}">
                                    <i class="bi bi-{{ status_info.icon }}"></i> {{ status_info.text }}
                                </span>
                            </td>
                            
                            <!-- Actions -->
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary btn-sm" 
                                            data-bs-toggle="tooltip" 
                                            title="Ver en botiquín"
                                            onclick="window.location.href='/botiquin/{{ med["botiquin_id"] }}'">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" 
                                            data-bs-toggle="tooltip" 
                                            title="Editar medicamento">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endfor %}

{% if total_medicines == 0 %}
<div class="text-center py-5">
    <i class="bi bi-capsule text-muted" style="font-size: 4rem;"></i>
    <h4 class="text-muted mt-3">
        {% if current_status %}
        No se encontraron medicamentos con estado "{{ current_status }}"
        {% else %}
        No hay medicamentos registrados
        {% endif %}
    </h4>
    <p class="text-muted">
        {% if current_status %}
        Prueba con un filtro diferente o revisa los botiquines.
        {% else %}
        Los medicamentos aparecerán aquí una vez que se registren en los botiquines.
        {% endif %}
    </p>
    <a href="/dashboard" class="btn btn-primary">
        <i class="bi bi-arrow-left"></i> Volver al Dashboard
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});
</script>
{% endblock %}