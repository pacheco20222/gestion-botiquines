{% extends "base.html" %}

{% block title %}Inventario de Botiquines{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/dashboard"><i class="bi bi-house"></i> Dashboard</a>
                </li>
                <li class="breadcrumb-item active">Inventario de Botiquines</li>
            </ol>
        </nav>
        <h2 class="mb-0">
            <i class="bi bi-hospital"></i> Inventario de Botiquines
        </h2>
        <p class="text-muted mb-0">Última sincronización registrada: {{ summary.last_update }}</p>
    </div>
</div>

<div class="row mb-4">
  <div class="col-md-3 mb-3">
    <div class="card text-center border-info">
      <div class="card-body">
        <i class="bi bi-hospital fs-1 text-info"></i>
        <h5 class="card-title">Total Botiquines</h5>
        <p class="card-text fs-4 fw-bold text-info">{{ summary.total_botiquines }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-center border-danger">
      <div class="card-body">
        <i class="bi bi-exclamation-octagon fs-1 text-danger"></i>
        <h5 class="card-title">Alertas Críticas</h5>
        <p class="card-text fs-4 fw-bold text-danger">{{ summary.critical_alerts }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-center border-warning">
      <div class="card-body">
        <i class="bi bi-exclamation-triangle fs-1 text-warning"></i>
        <h5 class="card-title">Alertas Preventivas</h5>
        <p class="card-text fs-4 fw-bold text-warning">{{ summary.warning_alerts }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-center border-secondary">
      <div class="card-body">
        <i class="bi bi-capsule-pill fs-1 text-muted"></i>
        <h5 class="card-title">Medicinas Totales</h5>
        <p class="card-text fs-4 text-muted">{{ summary.total_medicines }}</p>
      </div>
    </div>
  </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="bi bi-funnel"></i> Filtros por Estado (según medicinas del botiquín)
        </h6>
    </div>
    <div class="card-body py-2">
        <div class="btn-group flex-wrap" role="group">
            <a href="{{ url_for('pages.inventory') }}" 
               class="btn btn-outline-secondary btn-sm {% if not current_status %}active{% endif %}">
                <i class="bi bi-grid"></i> Todos
            </a>
            <a href="{{ url_for('pages.inventory', status='EXPIRED') }}" 
               class="btn btn-outline-danger btn-sm {% if current_status == 'EXPIRED' %}active{% endif %}">
                <i class="bi bi-x-circle"></i> Vencidos
            </a>
            <a href="{{ url_for('pages.inventory', status='EXPIRES_SOON') }}" 
               class="btn btn-outline-warning btn-sm {% if current_status == 'EXPIRES_SOON' %}active{% endif %}">
                <i class="bi bi-clock"></i> Por Vencer
            </a>
            <a href="{{ url_for('pages.inventory', status='EXPIRES_30') }}" 
               class="btn btn-outline-secondary btn-sm {% if current_status == 'EXPIRES_30' %}active{% endif %}">
                <i class="bi bi-calendar"></i> Vencen en 30 días
            </a>
            <a href="{{ url_for('pages.inventory', status='LOW_STOCK') }}" 
               class="btn btn-outline-warning btn-sm {% if current_status == 'LOW_STOCK' %}active{% endif %}">
                <i class="bi bi-exclamation-triangle"></i> Stock Bajo
            </a>
            <a href="{{ url_for('pages.inventory', status='OUT_OF_STOCK') }}" 
               class="btn btn-outline-dark btn-sm {% if current_status == 'OUT_OF_STOCK' %}active{% endif %}">
                <i class="bi bi-box"></i> Sin Stock
            </a>
            <a href="{{ url_for('pages.inventory', status='OK') }}" 
               class="btn btn-outline-success btn-sm {% if current_status == 'OK' %}active{% endif %}">
                <i class="bi bi-check-circle"></i> OK
            </a>
        </div>
    </div>
</div>

{% for group_name, data in grouped_data.items() %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">
                    <i class="bi bi-table"></i> {{ data.bot.name }}
                    {% if show_company %}
                        <span class="badge bg-primary ms-2">{{ data.bot.company_name or 'Sin asignar' }}</span>
                    {% endif %}
                </h5>
                <small class="text-muted">
                    {{ data.bot.location or 'Ubicación no especificada' }} · Última sync: {{ data.bot.last_sync }}
                </small>
                {% if current_status %}
                    <div><span class="badge bg-primary mt-1">Filtro aplicado: {{ current_status }}</span></div>
                {% endif %}
            </div>
            <div class="text-end">
                <a class="btn btn-sm btn-outline-primary" href="/botiquin/{{ data.bot.id }}">
                    <i class="bi bi-eye"></i> Ver botiquín
                </a>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">Compartimento</th>
                            <th>Medicamento</th>
                            <th>Marca</th>
                            <th>Concentración</th>
                            <th>Peso promedio</th>
                            <th>Peso actual</th>
                            <th>Cantidad</th>
                            <th>Reorden</th>
                            <th>Fecha vencimiento</th>
                            <th>Último escaneo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data.rows %}
                        <tr>
                            <td class="text-center">
                                <span class="badge bg-secondary"># {{ row.compartment }}</span>
                            </td>
                            <td>
                                {% if row.has_medicine %}
                                <div>
                                    <strong>{{ row.trade_name }}</strong>
                                    <br><small class="text-muted">{{ row.generic_name }}</small>
                                </div>
                                {% else %}
                                <span class="text-muted">Compartimento vacío</span>
                                {% endif %}
                            </td>
                            <td>{{ row.brand or 'N/A' }}</td>
                            <td>{{ row.strength or 'N/A' }}</td>
                            <td>
                                {% if row.average_weight is not none %}
                                    {{ '%.2f'|format(row.average_weight) }} g
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if row.current_weight is not none %}
                                    {{ '%.2f'|format(row.current_weight) }} g
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if row.has_medicine %}
                                    <strong>{{ row.quantity }}</strong>
                                    {% if row.max_capacity %}
                                        <br><small class="text-muted">Cap. {{ row.max_capacity }}</small>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">0</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if row.reorder_level is not none %}
                                    {{ row.reorder_level }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if row.expiry_date %}
                                    {{ row.expiry_date }}
                                    {% if row.days_to_expiry is not none %}
                                        {% if row.days_to_expiry < 0 %}
                                            <br><small class="text-danger">Vencido hace {{ -row.days_to_expiry }} días</small>
                                        {% elif row.days_to_expiry <= 30 %}
                                            <br><small class="text-warning">{{ row.days_to_expiry }} días restantes</small>
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">No especificada</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if row.last_scan %}
                                    <small>{{ row.last_scan }}</small>
                                {% else %}
                                    <small class="text-muted">Nunca</small>
                                {% endif %}
                            </td>
                            <td>
                                {% set status_map = {
                                    "OUT_OF_STOCK": {"class": "dark", "icon": "box", "text": "Sin stock"},
                                    "EXPIRED": {"class": "danger", "icon": "x-circle", "text": "Vencido"},
                                    "EXPIRES_SOON": {"class": "warning", "icon": "clock-history", "text": "Por vencer"},
                                    "EXPIRES_30": {"class": "secondary", "icon": "calendar3", "text": "Vence ≤30 días"},
                                    "LOW_STOCK": {"class": "warning", "icon": "exclamation-triangle", "text": "Stock bajo"},
                                    "OK": {"class": "success", "icon": "check-circle", "text": "OK"},
                                    "EMPTY": {"class": "light text-dark", "icon": "square", "text": "Vacío"}
                                } %}
                                {% set status_info = status_map.get(row.status, {"class": "secondary", "icon": "question", "text": row.status}) %}
                                <span class="badge bg-{{ status_info.class }}">
                                    <i class="bi bi-{{ status_info.icon }}"></i> {{ status_info.text }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a class="btn btn-outline-primary" href="/botiquin/{{ row.bot_id }}" data-bs-toggle="tooltip" title="Ver botiquín">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    {% if row.has_medicine %}
                                    <a class="btn btn-outline-secondary" href="/api/botiquines/{{ row.bot_id }}" data-bs-toggle="tooltip" title="Datos API">
                                        <i class="bi bi-diagram-3"></i>
                                    </a>
                                    {% endif %}
                            {% if current_user.is_super_admin() and not row.company_name %}
                                    <a class="btn btn-outline-success" href="/botiquin/{{ row.bot_id }}/assign" data-bs-toggle="tooltip" title="Asignar botiquín">
                                        <i class="bi bi-building"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endfor %}

{% if display_count == 0 %}
<div class="text-center py-5">
    <i class="bi bi-hospital text-muted" style="font-size: 4rem;"></i>
    <h4 class="text-muted mt-3">
        {% if current_status %}
        No se encontraron botiquines con el filtro "{{ current_status }}"
        {% else %}
        No hay botiquines registrados para tu usuario.
        {% endif %}
    </h4>
    <p class="text-muted">
        {% if current_status %}
        Prueba con un filtro diferente o revisa los estados de tus botiquines.
        {% else %}
        Los botiquines aparecerán aquí una vez que se asignen o registren en el sistema.
        {% endif %}
    </p>
    <a href="/dashboard" class="btn btn-primary">
        <i class="bi bi-arrow-left"></i> Volver al Dashboard
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});
</script>
{% endblock %}
