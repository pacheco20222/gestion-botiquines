{% extends "base.html" %}

{% block title %}Dashboard - Medicines{% endblock %}

{% block content %}
<h2 class="mb-4">Medicines Inventory</h2>

<div class="row mb-4">
  <div class="col-md-3 mb-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title">Total Medicines</h5>
        <p class="card-text fs-4">{{ summary.total }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-danger">Critical Alerts</h5>
        <p class="card-text fs-4">{{ summary.critical }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-warning">Low Stock</h5>
        <p class="card-text fs-4">{{ summary.low_stock }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title">Last Update</h5>
        <p class="card-text fs-6">{{ summary.last_update }}</p>
      </div>
    </div>
  </div>
</div>

<div class="btn-group mb-3 flex-wrap" role="group">
  <a href="{{ url_for('pages.dashboard') }}" class="btn btn-outline-secondary {% if not current_status %}active{% endif %}">All</a>
  <a href="{{ url_for('pages.dashboard', status='EXPIRED') }}" class="btn btn-outline-danger {% if current_status == 'EXPIRED' %}active{% endif %}">Expired</a>
  <a href="{{ url_for('pages.dashboard', status='EXPIRES_SOON') }}" class="btn btn-outline-warning {% if current_status == 'EXPIRES_SOON' %}active{% endif %}">Expiring Soon</a>
  <a href="{{ url_for('pages.dashboard', status='EXPIRES_30') }}" class="btn btn-outline-secondary {% if current_status == 'EXPIRES_30' %}active{% endif %}">Expires ≤30 days</a>
  <a href="{{ url_for('pages.dashboard', status='LOW_STOCK') }}" class="btn btn-outline-warning {% if current_status == 'LOW_STOCK' %}active{% endif %}">Low Stock</a>
  <a href="{{ url_for('pages.dashboard', status='OUT_OF_STOCK') }}" class="btn btn-outline-dark {% if current_status == 'OUT_OF_STOCK' %}active{% endif %}">Out of Stock</a>
</div>

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
          <tr>
              <th>ID</th>
              <th>Trade Name</th>
              <th>Generic Name</th>
              <th>Brand</th>
              <th>Strength</th>
              <th>Expiry Date</th>
              <th>Quantity</th>
              <th>Reorder Level</th>
              <th>Last Scan</th>
              <th>Created At</th>
              <th>Updated At</th>
              <th>Status</th>
          </tr>
      </thead>
      <tbody>
          {% for med in medicines %}
          <tr>
              <td>{{ med["id"] }}</td>
              <td>{{ med["trade_name"] }}</td>
              <td>{{ med["generic_name"] }}</td>
              <td>{{ med["brand"] }}</td>
              <td>{{ med["strength"] }}</td>
              <td>{{ med["expiry_date"] }}</td>
              <td>
                <div class="progress" style="height: 20px;">
                  {% set percent = (med["quantity"] / med["reorder_level"] * 100) if med["reorder_level"] > 0 else 0 %}
                  <div class="progress-bar {% if percent <= 0 %}bg-dark{% elif percent < 50 %}bg-warning text-dark{% else %}bg-success{% endif %}"
                       role="progressbar"
                       style="width: {{ percent if percent <= 100 else 100 }}%;"
                       aria-valuenow="{{ percent|round(0) }}" aria-valuemin="0" aria-valuemax="100">
                    {{ med["quantity"] }}
                  </div>
                </div>
              </td>
              <td>{{ med["reorder_level"] }}</td>
              <td>{{ med["last_scan_at"] }}</td>
              <td>{{ med["created_at"] }}</td>
              <td>{{ med["updated_at"] }}</td>
              <td>
                  {% if med["status"] == "OUT_OF_STOCK" %}
                      <span class="badge bg-dark">Out of Stock</span>
                  {% elif med["status"] == "EXPIRED" %}
                      <span class="badge bg-danger">Expired</span>
                  {% elif med["status"] == "EXPIRES_SOON" %}
                      <span class="badge bg-warning text-dark">Expiring Soon</span>
                  {% elif med["status"] == "EXPIRES_30" %}
                      <span class="badge bg-secondary">Expires ≤30 days</span>
                  {% elif med["status"] == "LOW_STOCK" %}
                      <span class="badge bg-warning text-dark">Low Stock</span>
                  {% else %}
                      <span class="badge bg-success">OK</span>
                  {% endif %}
              </td>
          </tr>
          {% endfor %}
      </tbody>
  </table>
</div>
{% endblock %}